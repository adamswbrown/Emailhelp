#!/usr/bin/env python3
"""
main_app.py - Native macOS Email Triage Application

A native macOS window application for email triage and categorization.
Uses PyWebView for native window with HTML/CSS/JS UI.

Features:
- Native macOS window (not a browser)
- Direct database access to Mail.app/Outlook
- Compose and send replies
- GPT integration for drafting
- Auto-refresh for new emails
- Mark emails as done
"""

import webview
import json
import sys
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Optional

# Import our existing modules
from email_reader import create_reader
from scoring import EmailScorer
from classifier import EmailClassifier
from preview import EmailPreview
from reply_handler import ReplyHandler
from actions.gpt_export import GPTExporter
from actions.mark_done import DoneTracker


class EmailTriageAPI:
    """Backend API for the email triage application."""
    
    def __init__(self, client='auto', account='ews'):
        """
        Initialize the API.
        
        Args:
            client: Email client ('auto', 'apple-mail', or 'outlook')
            account: Default account to filter
        """
        self.client = client
        self.account = account
        self.reader = None
        self.scorer = EmailScorer()
        self.classifier = EmailClassifier()
        self._done_tracker = DoneTracker()
        self.reply_handler = None
        
        # Initialize reader
        try:
            self.reader = create_reader(client=client if client != 'auto' else None)
            
            # Determine which client we're using for reply handler
            detected_client = 'apple-mail'
            if hasattr(self.reader, '__class__'):
                class_name = self.reader.__class__.__name__
                if 'Outlook' in class_name:
                    detected_client = 'outlook'
            
            self.reply_handler = ReplyHandler(client=detected_client)
            
        except Exception as e:
            print(f"Error initializing reader: {e}", file=sys.stderr)
            raise
    
    def get_emails(self, account: str = None, limit: int = 50, since_days: int = 7, category_filter: str = None):
        """
        Get categorized emails.
        
        Args:
            account: Account to filter (default: self.account)
            limit: Maximum number of emails
            since_days: Days to look back
            category_filter: Filter by category (ACTION, FYI, IGNORE)
        
        Returns:
            JSON string of email list
        """
        try:
            if account is None:
                account = self.account
            
            with self.reader:
                messages = self.reader.query_messages(
                    account=account,
                    limit=limit,
                    since_days=since_days
                )
            
            # Process and categorize
            emails = []
            print(f"[API] Processing {len(messages)} messages...", file=sys.stderr)
            for msg in messages:
                # Get email ID
                email_id = msg.get('message_id') or msg.get('ROWID')
                
                # Skip if marked as done
                if self._done_tracker.is_done(email_id):
                    continue
                
                # Extract fields
                sender = msg.get('sender', '') or ''
                subject = msg.get('subject', '') or ''
                sender = msg.get('sender', '') or ''
                subject = msg.get('subject', '') or ''
                # Get preview using AppleScript (fast and reliable)
                preview = ''
                preview_display = 'No preview available'
                
                if sender and subject:
                    try:
                        from fast_content_extract import get_email_content_by_details
                        # Map account name for AppleScript
                        applescript_account = account if account else self.account
                        account_map = {'ews': 'Exchange', 'EWS': 'Exchange'}
                        applescript_account = account_map.get(applescript_account, applescript_account)
                        
                        # Get quick preview (first 300 chars) with short timeout
                        full_content = get_email_content_by_details(
                            account=applescript_account,
                            subject=subject,
                            sender=sender,
                            mailbox='INBOX',
                            timeout=3
                        )
                        
                        if full_content:
                            import re
                            preview = re.sub(r'<[^>]+>', '', full_content)
                            preview = ' '.join(preview.split())
                            preview_display = preview[:300] + '...' if len(preview) > 300 else preview
                    except Exception:
                        pass
